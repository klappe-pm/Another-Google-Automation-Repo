# Makefile for GCP Test Environment Management

.PHONY: help build up down shell validate clean setup-cloud-shell

# Default target
help: ## Show this help message
	@echo "GCP Test Environment Commands:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "Environment Variables (optional):"
	@echo "  GITHUB_SHA      - Git commit SHA"
	@echo "  GITHUB_REF      - Git reference (default: refs/heads/main)"
	@echo "  PROJECT_ID      - GCP Project ID"
	@echo ""
	@echo "Examples:"
	@echo "  make up                    # Start the test environment"
	@echo "  make shell                 # Enter the container shell"
	@echo "  GITHUB_SHA=abc123 make up  # Start with custom SHA"

build: ## Build the Docker container
	@echo "ğŸ”¨ Building Docker container..."
	docker-compose build

up: build ## Start the test environment (builds if needed)
	@echo "ğŸš€ Starting test environment..."
	docker-compose up -d
	@echo "âœ… Test environment is running"
	@echo "   Enter with: make shell"

down: ## Stop the test environment
	@echo "ğŸ›‘ Stopping test environment..."
	docker-compose down
	@echo "âœ… Test environment stopped"

shell: ## Enter the container shell
	@echo "ğŸš Entering container shell..."
	docker-compose exec test-env bash

validate: ## Validate the environment setup (inside container)
	@echo "ğŸ” Validating environment..."
	docker-compose exec test-env ./test-environment/validate-environment.sh

logs: ## Show container logs
	docker-compose logs -f test-env

setup-cloud-shell: ## Run Cloud Shell setup script
	@echo "â˜ï¸  Setting up Cloud Shell environment..."
	./setup-cloud-shell.sh

clean: down ## Clean up containers, volumes, and images
	@echo "ğŸ§¹ Cleaning up..."
	docker-compose down -v
	docker system prune -f
	@echo "âœ… Cleanup complete"

restart: down up ## Restart the test environment

status: ## Show container status
	@echo "ğŸ“Š Container status:"
	docker-compose ps

# Development targets
dev-setup: up ## Set up environment for development
	@echo "ğŸ”§ Setting up development environment..."
	docker-compose exec test-env npm install
	@echo "âœ… Development environment ready"

dev-test: ## Run tests in the container
	@echo "ğŸ§ª Running tests..."
	docker-compose exec test-env npm test || echo "No test script found"

dev-deploy: ## Test deployment in container
	@echo "ğŸš€ Testing deployment..."
	docker-compose exec test-env npm run deploy

# Utility targets
env-check: ## Check current environment variables
	@echo "ğŸŒ Current environment variables:"
	@echo "  GITHUB_SHA: $(GITHUB_SHA)"
	@echo "  GITHUB_REF: $(GITHUB_REF)"
	@echo "  PROJECT_ID: $(PROJECT_ID)"

docker-info: ## Show Docker system information
	@echo "ğŸ³ Docker system info:"
	@docker info --format "Version: {{.ServerVersion}}"
	@docker info --format "CPUs: {{.NCPU}}"
	@docker info --format "Memory: {{.MemTotal}}"
